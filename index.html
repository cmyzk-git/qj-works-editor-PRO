<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>求人情報一括登録サポートツール v2.1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f1f5f9; }
        .required-badge::after { content: "必須"; margin-left: 6px; font-size: 0.65rem; background: #ef4444; color: white; padding: 2px 5px; border-radius: 4px; vertical-align: middle; font-weight: bold; }
        .duplicate-error { border-color: #ef4444 !important; background-color: #fef2f2; }
        details summary::-webkit-details-marker { display:none; }
        summary { cursor: pointer; list-style: none; }
    </style>
</head>
<body class="p-2 md:p-6 pb-24">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-slate-900 p-4 md:p-6 text-white rounded-t-2xl flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-xl font-bold flex items-center gap-2">
                    求人原稿作成フォーム 
                    <span class="text-xs bg-blue-500 px-2 py-0.5 rounded-full font-normal">v2.1.0</span>
                </h1>
                <p class="text-slate-400 text-xs mt-1">自動保存・必須項目強調版</p>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <button onclick="addNewJob()" class="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-500 text-sm px-4 py-2 rounded-lg transition font-bold flex items-center justify-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    新規案件を追加
                </button>
                <button onclick="downloadCSV()" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-500 text-sm px-4 py-2 rounded-lg transition font-bold">一括CSV保存</button>
            </div>
        </div>

        <!-- Job List Container -->
        <div id="jobList" class="space-y-6 mt-4">
            <!-- 職種カードがここに動的に追加される -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden bg-white border-2 border-dashed border-slate-300 rounded-2xl p-12 text-center">
            <p class="text-slate-400">登録されている案件がありません。「新規案件を追加」から作成してください。</p>
        </div>
    </div>

    <!-- Job Card Template (Hidden) -->
    <template id="jobCardTemplate">
        <div class="job-card bg-white shadow-md rounded-2xl overflow-hidden border border-slate-200 transition-all">
            <!-- Card Header -->
            <div class="bg-slate-50 px-4 py-3 border-b flex justify-between items-center">
                <span class="text-xs font-bold text-slate-500 uppercase tracking-wider card-number">案件 #1</span>
                <div class="flex gap-3">
                    <button onclick="copyJob(this)" class="text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center gap-1">
                        コピーして作成
                    </button>
                    <button onclick="removeJob(this)" class="text-rose-600 hover:text-rose-800 text-xs font-bold">
                        削除
                    </button>
                </div>
            </div>

            <div class="p-4 md:p-6 space-y-8">
                <!-- 1. 基本情報 -->
                <section>
                    <h3 class="text-sm font-bold text-slate-800 mb-4 border-l-4 border-blue-500 pl-2">1. 基本設定</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1 required-badge">職種</label>
                            <select name="job_title" onchange="handleInputChange()" class="job-title-input w-full border p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="店長候補・マネージャー" selected>店長候補・マネージャー</option>
                                <option value="サービス・ホール">サービス・ホール</option>
                                <option value="料理長候補（シェフ・板前など）">料理長候補（シェフ・板前など）</option>
                                <option value="調理スタッフ">調理スタッフ</option>
                                <option value="調理補助・調理見習い">調理補助・調理見習い</option>
                                <option value="パティシエ">パティシエ</option>
                                <option value="パン職人・ブーランジェ">パン職人・ブーランジェ</option>
                                <option value="ピザ職人・ピッツァイオーロ">ピザ職人・ピッツァイオーロ</option>
                                <option value="ソムリエ">ソムリエ</option>
                                <option value="バーテンダー">バーテンダー</option>
                                <option value="バリスタ">バリスタ</option>
                                <option value="レセプション・フロント">レセプション・フロント</option>
                                <option value="洗い場・皿洗い">洗い場・皿洗い</option>
                                <option value="販売スタッフ">販売スタッフ</option>
                                <option value="本部スタッフ・SV">本部スタッフ・SV</option>
                                <option value="デリバリー・配達スタッフ">デリバリー・配達スタッフ</option>
                                <option value="食品加工・製造（精肉・鮮魚等）">食品加工・製造（精肉・鮮魚等）</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1 required-badge">雇用形態</label>
                            <select name="employment_type" onchange="handleInputChange()" class="employment-type-input w-full border p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="正社員">正社員</option>
                                <option value="アルバイト・パート">アルバイト・パート</option>
                                <option value="契約社員">契約社員</option>
                                <option value="業務委託">業務委託</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">応募資格</label>
                            <input type="text" name="qualification" oninput="saveData()" class="w-full border p-2 rounded-lg text-sm" placeholder="例：高卒以上、経験者歓迎">
                        </div>
                    </div>
                    <div class="duplicate-warning hidden mt-2 text-rose-600 text-[10px] font-bold">
                        ⚠️ 同じ雇用形態・同じ職種の案件が既に存在します。
                    </div>
                </section>

                <!-- 2. 給与・特徴 -->
                <section>
                    <h3 class="text-sm font-bold text-slate-800 mb-4 border-l-4 border-emerald-500 pl-2">2. 給与・特徴</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1 required-badge">給与種別</label>
                            <select name="salary_type" onchange="saveData()" class="w-full border p-2 rounded-lg text-sm">
                                <option value="月給">月給</option>
                                <option value="時給">時給</option>
                                <option value="年俸">年俸</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1 required-badge">給与下限</label>
                            <input type="number" name="salary_min" oninput="saveData()" class="w-full border p-2 rounded-lg text-sm" placeholder="250000">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">給与上限</label>
                            <input type="number" name="salary_max" oninput="saveData()" class="w-full border p-2 rounded-lg text-sm" placeholder="450000">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">給与備考</label>
                            <input type="text" name="salary_note" oninput="saveData()" class="w-full border p-2 rounded-lg text-sm" placeholder="経験・能力を考慮">
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">特徴・給与詳細</p>
                        <div class="flex flex-wrap gap-2 text-xs">
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="char_no_resume" onchange="saveData()"> 履歴書不要</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="char_new_grad" onchange="saveData()"> 新卒歓迎</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="char_inexperienced" onchange="saveData()"> 未経験者歓迎</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="char_independent" onchange="saveData()"> 独立希望者歓迎</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="char_experienced" onchange="saveData()"> 経験者優遇</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_bonus" onchange="saveData()"> 賞与あり</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_rise" onchange="saveData()"> 昇給あり</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_dorm" onchange="saveData()"> 寮・住宅手当</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_train_full" onchange="saveData()"> 交通費全額</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_family" onchange="saveData()"> 家族手当</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_skill" onchange="saveData()"> 資格手当</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_incentive" onchange="saveData()"> インセンティブ</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_retire" onchange="saveData()"> 退職金</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_daily" onchange="saveData()"> 日払いOK</label>
                            <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_fuyo" onchange="saveData()"> 扶養内OK</label>
                        </div>
                    </div>
                </section>

                <!-- 3. 勤務時間・休日 -->
                <section>
                    <h3 class="text-sm font-bold text-slate-800 mb-4 border-l-4 border-orange-500 pl-2">3. 勤務時間・休日</h3>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-600 mb-1 required-badge">勤務時間（説明）</label>
                        <input type="text" name="work_time_text" oninput="saveData()" class="w-full border p-2 rounded-lg text-sm" placeholder="10:00〜23:00（シフト制、実働8h）">
                    </div>
                    <div class="flex flex-wrap gap-2 text-xs mb-4">
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="work_lunch" onchange="saveData()"> ランチのみ</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="work_train" onchange="saveData()"> 終電考慮</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="work_w" onchange="saveData()"> 副業・WワークOK</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="work_full" onchange="saveData()"> フルタイム歓迎</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="work_ot" onchange="saveData()"> 残業月20h以内</label>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-600 mb-1 required-badge">休日・休暇（説明）</label>
                        <input type="text" name="holiday_text" oninput="saveData()" class="w-full border p-2 rounded-lg text-sm" placeholder="月8日休み、夏季・冬季休暇あり">
                    </div>
                    <div class="flex flex-wrap gap-2 text-xs">
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="hol_8" onchange="saveData()"> 月8日以上</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="hol_9" onchange="saveData()"> 月9日以上</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="hol_2" onchange="saveData()"> 完全週休2日</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="hol_baby" onchange="saveData()"> 産休・育休</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="hol_summer" onchange="saveData()"> 夏季休暇</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="hol_winter" onchange="saveData()"> 年末年始</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="hol_gw" onchange="saveData()"> GW休暇</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="hol_spec" onchange="saveData()"> 特別休暇</label>
                    </div>
                </section>

                <!-- 4. 待遇・研修 -->
                <section>
                    <h3 class="text-sm font-bold text-slate-800 mb-4 border-l-4 border-indigo-500 pl-2">4. 待遇・福利厚生</h3>
                    <div class="flex flex-wrap gap-2 text-xs">
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_makanai" onchange="saveData()"> まかないあり</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_ins" onchange="saveData()"> 社会保険完備</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_uniform" onchange="saveData()"> 制服貸与</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_training" onchange="saveData()"> 研修充実</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_overseas" onchange="saveData()"> 海外研修</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_visit" onchange="saveData()"> 生産者訪問</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_license" onchange="saveData()"> 資格取得支援</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_car" onchange="saveData()"> 車・バイク通勤OK</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_emp" onchange="saveData()"> 社員登用あり</label>
                        <label class="flex items-center gap-1 border p-1.5 rounded-lg bg-slate-50"><input type="checkbox" name="ben_hair" onchange="saveData()"> 髪型自由</label>
                    </div>
                </section>

                <!-- 5. スキル・知識 -->
                <section class="bg-slate-50 p-4 rounded-xl">
                    <h3 class="text-sm font-bold text-slate-800 mb-4">5. 身につくスキル・学べる知識</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">【技術・スキル】</p>
                            <div class="flex flex-wrap gap-2 text-[11px]">
                                <label class="flex items-center gap-1"><input type="checkbox" name="sk_latte" onchange="saveData()"> ラテアート</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="sk_knife" onchange="saveData()"> 包丁さばき</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="sk_deco" onchange="saveData()"> 飾り包丁</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="sk_pizza" onchange="saveData()"> ピザメイク</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="sk_noodle" onchange="saveData()"> 製麺</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="sk_sushi" onchange="saveData()"> 寿司技術</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="sk_plating" onchange="saveData()"> 盛り付け</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="sk_bread" onchange="saveData()"> 製パン</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="sk_pastry" onchange="saveData()"> 製菓</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="sk_cocktail" onchange="saveData()"> カクテル</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="sk_premium" onchange="saveData()"> 高級食材</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="sk_english" onchange="saveData()"> 英会話</label>
                            </div>
                        </div>

                        <div>
                            <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">【専門知識】</p>
                            <div class="flex flex-wrap gap-2 text-[11px]">
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_wine" onchange="saveData()"> ワイン</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_sake" onchange="saveData()"> 日本酒</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_liquor" onchange="saveData()"> お酒全般</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_coffee" onchange="saveData()"> コーヒー</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_tea" onchange="saveData()"> お茶</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_meat" onchange="saveData()"> 肉</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_fish" onchange="saveData()"> 魚</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_vege" onchange="saveData()"> 野菜</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_cheese" onchange="saveData()"> チーズ</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_w_sweets" onchange="saveData()"> 洋菓子</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_j_sweets" onchange="saveData()"> 和菓子</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_tableware" onchange="saveData()"> 食器</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_wedding" onchange="saveData()"> 婚礼・パーティ</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_manner" onchange="saveData()"> テーブルマナー</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="kn_kimono" onchange="saveData()"> 着付け</label>
                            </div>
                        </div>

                        <div>
                            <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">【ノウハウ】</p>
                            <div class="flex flex-wrap gap-2 text-[11px]">
                                <label class="flex items-center gap-1"><input type="checkbox" name="no_open" onchange="saveData()"> 出店開業</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="no_mgmt" onchange="saveData()"> 店舗運営</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="no_menu" onchange="saveData()"> メニュー開発</label>
                                <label class="flex items-center gap-1"><input type="checkbox" name="no_stock" onchange="saveData()"> 仕入れ・食材調達</label>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 6. 本文 -->
                <section>
                    <label class="block text-sm font-bold text-slate-800 mb-2 required-badge">仕事内容・求める人物像</label>
                    <textarea name="content" oninput="saveData()" class="w-full h-48 border p-4 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 leading-relaxed" placeholder="仕事内容の詳細をご記入ください。"></textarea>
                </section>
            </div>
        </div>
    </template>

    <script>
        const jobList = document.getElementById('jobList');
        const emptyState = document.getElementById('emptyState');
        const template = document.getElementById('jobCardTemplate');
        const STORAGE_KEY = 'job_form_data_v2_1_0_stable';

        const CSV_HEADERS = [
            "下書き原稿のID", "職種", "雇用形態", "履歴書不要", "新卒歓迎", "未経験者歓迎", "独立希望者歓迎", "経験者優遇", "給与", "下限", "上限", "給与備考", "ボーナス・賞与あり", "昇給あり", "寮・住宅手当あり", "交通費全額支給", "家族手当", "資格手当・スキル手当", "インセンティブ制度", "退職金", "日払いOK", "扶養内OK", "応募資格", "勤務時間", "ランチのお仕事", "終電考慮", "副業・ダブルワークOK", "フルタイム歓迎", "残業月20時間以内", "休日・休暇", "月8日以上休み", "月9日以上休み", "完全週休2日制", "産休・育休", "夏季休暇", "年末年始休暇", "GW休暇", "特別休暇", "待遇", "まかない・食事補助あり", "社会保険完備", "制服貸与", "研修が充実", "海外研修", "生産者訪問", "資格取得支援", "バイク・車通勤OK", "社員登用制度", "髪型自由", "仕事内容・求める人材", "ラテアート", "包丁さばき", "飾り包丁", "ピザメイク", "製麺", "寿司技術", "盛り付け技術", "製パン技術", "製菓技術", "カクテル技法", "高級食材の知識", "英会話", "ワインの知識", "日本酒の知識", "お酒の知識", "コーヒーの知識", "お茶の知識", "肉の知識", "魚の知識", "野菜の知識", "チーズの知識", "洋菓子の知識", "和菓子の知識", "食器の知識", "婚礼料理・パーティーメニュー", "テーブルマナー", "着物の着付け", "出店開業ノウハウ", "店舗運営", "メニュー開発", "仕入れ・食材調達"
        ];

        // 初期化とデータ復元
        window.onload = () => {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                try {
                    const jobs = JSON.parse(savedData);
                    if (jobs.length > 0) {
                        jobs.forEach(data => addNewJob(data, false));
                    } else {
                        addNewJob();
                    }
                } catch (e) {
                    addNewJob();
                }
            } else {
                addNewJob();
            }
        };

        // 保存処理
        let saveTimeout;
        function saveData() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const jobs = [];
                jobList.querySelectorAll('.job-card').forEach(card => {
                    const data = {};
                    card.querySelectorAll('input, select, textarea').forEach(el => {
                        if (el.type === 'checkbox') data[el.name] = el.checked;
                        else data[el.name] = el.value;
                    });
                    jobs.push(data);
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(jobs));
            }, 500);
        }

        function handleInputChange() {
            validateDuplicates();
            saveData();
        }

        function addNewJob(data = null, shouldSave = true) {
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector('.job-card');
            
            if (data) {
                Object.keys(data).forEach(key => {
                    const el = card.querySelector(`[name="${key}"]`);
                    if (el) {
                        if (el.type === 'checkbox') el.checked = data[key];
                        else el.value = data[key];
                    }
                });
            }

            jobList.appendChild(clone);
            updateNumbers();
            validateDuplicates();
            if (shouldSave) saveData();
        }

        function removeJob(btn) {
            if(!confirm("この案件を削除してもよろしいですか？")) return;
            btn.closest('.job-card').remove();
            updateNumbers();
            validateDuplicates();
            saveData();
            if (jobList.children.length === 0) emptyState.classList.remove('hidden');
        }

        function copyJob(btn) {
            const card = btn.closest('.job-card');
            const data = {};
            card.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.type === 'checkbox') data[el.name] = el.checked;
                else data[el.name] = el.value;
            });
            addNewJob(data);
        }

        function updateNumbers() {
            jobList.querySelectorAll('.job-card').forEach((card, i) => {
                card.querySelector('.card-number').innerText = `案件 #${i + 1}`;
            });
            emptyState.classList.toggle('hidden', jobList.children.length > 0);
        }

        function validateDuplicates() {
            const seen = new Set();
            let hasError = false;
            jobList.querySelectorAll('.job-card').forEach(card => {
                const title = card.querySelector('.job-title-input').value;
                const type = card.querySelector('.employment-type-input').value;
                const warning = card.querySelector('.duplicate-warning');
                if (!title || !type) return;
                const key = `${title}-${type}`;
                if (seen.has(key)) {
                    warning.classList.remove('hidden');
                    card.classList.add('duplicate-error');
                    hasError = true;
                } else {
                    seen.add(key);
                    warning.classList.add('hidden');
                    card.classList.remove('duplicate-error');
                }
            });
            return hasError;
        }

        function downloadCSV() {
            if (validateDuplicates()) {
                if(!confirm("職種と雇用形態が重複している案件があります。そのまま出力しますか？")) return;
            }

            const rows = [CSV_HEADERS.join(",")];
            jobList.querySelectorAll('.job-card').forEach(card => {
                const getVal = (name) => {
                    const el = card.querySelector(`[name="${name}"]`);
                    return el ? el.value : "";
                };
                const isChk = (name) => {
                    const el = card.querySelector(`[name="${name}"]`);
                    return (el && el.checked) ? "1" : "";
                };

                const row = [
                    "", // ID
                    `"${getVal('job_title')}"`, 
                    `"${getVal('employment_type')}"`,
                    isChk('char_no_resume'), isChk('char_new_grad'), isChk('char_inexperienced'), isChk('char_independent'), isChk('char_experienced'),
                    `"${getVal('salary_type')}"`, getVal('salary_min'), getVal('salary_max'), `"${getVal('salary_note')}"`,
                    isChk('ben_bonus'), isChk('ben_rise'), isChk('ben_dorm'), isChk('ben_train_full'), isChk('ben_family'), isChk('ben_skill'), isChk('ben_incentive'), isChk('ben_retire'), isChk('ben_daily'), isChk('ben_fuyo'),
                    `"${getVal('qualification')}"`, 
                    `"${getVal('work_time_text')}"`,
                    isChk('work_lunch'), isChk('work_train'), isChk('work_w'), isChk('work_full'), isChk('work_ot'),
                    `"${getVal('holiday_text')}"`,
                    isChk('hol_8'), isChk('hol_9'), isChk('hol_2'), isChk('hol_baby'), isChk('hol_summer'), isChk('hol_winter'), isChk('hol_gw'), isChk('hol_spec'),
                    "", // 待遇
                    isChk('ben_makanai'), isChk('ben_ins'), isChk('ben_uniform'), isChk('ben_training'), isChk('ben_overseas'), isChk('ben_visit'), isChk('ben_license'), isChk('ben_car'), isChk('ben_emp'), isChk('ben_hair'),
                    `"${getVal('content').replace(/\r?\n/g, "<br>").replace(/"/g, '""')}"`,
                    isChk('sk_latte'), isChk('sk_knife'), isChk('sk_deco'), isChk('sk_pizza'), isChk('sk_noodle'), isChk('sk_sushi'), isChk('sk_plating'), isChk('sk_bread'), isChk('sk_pastry'), isChk('sk_cocktail'), isChk('sk_premium'), isChk('sk_english'),
                    isChk('kn_wine'), isChk('kn_sake'), isChk('kn_liquor'), isChk('kn_coffee'), isChk('kn_tea'), isChk('kn_meat'), isChk('kn_fish'), isChk('kn_vege'), isChk('kn_cheese'), isChk('kn_w_sweets'), isChk('kn_j_sweets'), isChk('kn_tableware'), isChk('kn_wedding'), isChk('kn_manner'), isChk('kn_kimono'),
                    isChk('no_open'), isChk('no_mgmt'), isChk('no_menu'), isChk('no_stock')
                ];
                rows.push(row.join(","));
            });

            const csvContent = "\uFEFF" + rows.join("\n");
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `求人出力_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }
    </script>
</body>
</html>
